<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WBCHSE Class XII - ‡¶∏‡¶æ‡¶π‡¶ø‡¶§‡ßç‡¶Ø ‡¶ö‡¶∞‡ßç‡¶ö‡¶æ (Mock Exam)</title>
    <!-- Google Fonts for Bengali -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Bengali:wght@400;600;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #1565c0; /* Deep Blue */
            --secondary: #42a5f5; /* Light Blue */
            --accent: #ef6c00; /* Orange */
            --success: #2e7d32; /* Green */
            --bg-color: #f5f7fa;
            --card-bg: #ffffff;
            --text-main: #37474f;
            --text-light: #78909c;
            --border-radius: 16px;
            --shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Noto Serif Bengali', serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            user-select: none; /* Anti-copy */
            -webkit-user-select: none;
        }

        /* Container Layout */
        .container {
            max-width: 850px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.6s forwards ease-out;
            display: none; /* ALL screens hidden by default */
        }

        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }

        /* Typography */
        h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
            font-size: 2rem;
            letter-spacing: -0.5px;
        }
        h2 {
            font-size: 1.3rem;
            color: var(--text-light);
            margin-top: 0;
            font-weight: 500;
        }

        /* Login Screen Styles */
        #login-screen {
            text-align: center;
            max-width: 500px;
            margin-top: 8vh;
            padding: 50px;
        }

        .hero-icon {
            font-size: 4.5rem;
            margin-bottom: 20px;
            display: inline-block;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }

        .input-group {
            margin: 35px 0;
            position: relative;
        }

        input[type="text"] {
            width: 100%;
            padding: 18px 25px;
            font-size: 1.1rem;
            border: 2px solid #eceff1;
            border-radius: 50px;
            outline: none;
            transition: all 0.3s;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
            background: #fafafa;
            text-align: center;
        }

        input[type="text"]:focus {
            border-color: var(--secondary);
            background: #fff;
            box-shadow: 0 4px 15px rgba(66, 165, 245, 0.15);
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 16px 45px;
            font-size: 1.1rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(21, 101, 192, 0.3);
            transition: all 0.3s;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(21, 101, 192, 0.4);
        }

        .btn:disabled {
            background: #cfd8dc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-active {
            background: linear-gradient(135deg, var(--success), #43a047) !important;
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(46, 125, 50, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(46, 125, 50, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 125, 50, 0); }
        }

        /* Loading Screens */
        #startup-loader, #processing-loader {
            text-align: center;
            padding: 80px 0;
            display: none;
        }

        .loader-ring {
            display: inline-block;
            width: 70px;
            height: 70px;
        }
        .loader-ring:after {
            content: " ";
            display: block;
            width: 50px;
            height: 50px;
            margin: 8px;
            border-radius: 50%;
            border: 6px solid var(--secondary);
            border-color: var(--secondary) transparent var(--secondary) transparent;
            animation: ring 1.2s linear infinite;
        }
        @keyframes ring {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Exam Screen */
        .exam-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: white;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.04);
            margin: -40px -40px 30px -40px; /* Stretch to edges */
            border-bottom: 1px solid #f0f0f0;
        }

        .student-info {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .timer-badge {
            background: #fff3e0;
            color: var(--accent);
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
            border: 2px solid #ffe0b2;
            min-width: 110px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(255, 111, 0, 0.1);
        }

        .timer-badge.critical {
            background: #ffebee;
            color: #d32f2f;
            border-color: #ffcdd2;
            animation: pulse 1s infinite;
        }

        /* Questions */
        .section-header {
            background: linear-gradient(to right, #e3f2fd, #ffffff);
            color: var(--primary);
            padding: 15px 25px;
            border-radius: 8px;
            margin: 40px 0 25px 0;
            font-weight: 700;
            border-left: 6px solid var(--secondary);
            font-size: 1.1rem;
        }

        .question-card {
            background: white;
            border: 1px solid #f0f0f0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .question-card:hover {
            border-color: #bbdefb;
            box-shadow: 0 5px 15px rgba(0,0,0,0.03);
            transform: translateY(-2px);
        }

        .q-text {
            display: block;
            font-size: 1.15rem;
            margin-bottom: 15px;
            line-height: 1.6;
            color: var(--text-main);
        }
        
        .marks-tag {
            float: right;
            background: #eceff1;
            color: #546e7a;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
        }

        textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #eceff1;
            border-radius: 10px;
            font-family: 'Noto Serif Bengali', serif;
            font-size: 1.05rem;
            line-height: 1.6;
            resize: vertical;
            background: #fafafa;
            transition: all 0.3s;
            box-sizing: border-box;
            min-height: 60px;
        }

        textarea:focus {
            background: white;
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 4px 12px rgba(66, 165, 245, 0.1);
        }

        /* Result Screen */
        .score-circle {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: white;
            border: 8px solid var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            font-weight: bold;
            color: var(--primary);
            margin: 30px auto;
            box-shadow: 0 10px 30px rgba(21, 101, 192, 0.2);
            font-family: 'Poppins', sans-serif;
        }

        .feedback-box {
            background: #fff8e1;
            border-left: 5px solid #ffca28;
            padding: 25px;
            border-radius: 8px;
            margin-top: 40px;
            text-align: left;
            line-height: 1.8;
            white-space: pre-wrap;
            font-size: 1.05rem;
            color: #5d4037;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

    </style>
</head>
<body>

    <!-- SCREEN 1: LOGIN -->
    <div id="login-screen" class="container">
        <div class="hero-icon">üìù</div>
        <h1>WBCHSE Class XII</h1>
        <h2>‡¶∏‡¶æ‡¶π‡¶ø‡¶§‡ßç‡¶Ø ‡¶ö‡¶∞‡ßç‡¶ö‡¶æ - ‡¶π‡¶≤‡ßÅ‡¶¶ ‡¶™‡ßã‡ßú‡¶æ</h2>
        
        <div style="background: #e1f5fe; color: #0277bd; padding: 20px; border-radius: 12px; margin: 30px 0; text-align: left; font-size: 0.95rem; border: 1px solid #b3e5fc;">
            <strong>üìã ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶®‡¶ø‡ßü‡¶Æ‡¶æ‡¶¨‡¶≤‡ßÄ:</strong>
            <ul style="margin: 10px 0 0 20px; padding: 0; line-height: 1.6;">
                <li>‡¶∏‡¶Æ‡ßü: ‡ß® ‡¶ò‡¶£‡ßç‡¶ü‡¶æ (‡ßß‡ß®‡ß¶ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü)‡•§</li>
                <li>‡¶ï‡¶™‡¶ø-‡¶™‡ßá‡¶∏‡ßç‡¶ü ‡¶¨‡¶æ ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨ ‡¶ñ‡ßã‡¶≤‡¶æ ‡¶®‡¶ø‡¶∑‡¶ø‡¶¶‡ßç‡¶ß‡•§</li>
                <li>‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡¶≤‡ßá ‡¶ü‡¶æ‡¶á‡¶Æ‡¶æ‡¶∞ ‡¶•‡¶æ‡¶Æ‡¶¨‡ßá ‡¶®‡¶æ‡•§</li>
            </ul>
        </div>

        <div class="input-group">
            <input type="text" id="student-name" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (Name)" autocomplete="off">
        </div>
        
        <button class="btn" onclick="initiateExamSequence()">‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶® (Start Exam)</button>
    </div>

    <!-- SCREEN 1.5: STARTUP LOADER -->
    <div id="startup-loader" class="container">
        <div class="loader-ring"></div>
        <h3 style="color: var(--primary); margin-top: 25px;">‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶™‡ßç‡¶∞‡¶∏‡ßç‡¶§‡ßÅ‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</h3>
        <p style="color: var(--text-light);">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶™‡¶§‡ßç‡¶∞ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§</p>
    </div>

    <!-- SCREEN 2: EXAM INTERFACE -->
    <div id="exam-screen" class="container">
        <div class="exam-header">
            <div class="student-info">
                üë§ <span id="display-name">Loading...</span>
            </div>
            <div id="timer-display" class="timer-badge">--:--:--</div>
        </div>
        
        <form id="exam-form">
            <div id="questions-container"></div>
            
            <div style="text-align: center; margin-top: 50px; padding-top: 20px; border-top: 1px dashed #e0e0e0;">
                <button type="button" id="submit-btn" class="btn" onclick="submitExam()" disabled>
                    Loading...
                </button>
                <p id="progress-text" style="font-size: 0.9rem; color: #90a4ae; margin-top: 15px;">
                    ‡¶∏‡¶¨ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡¶ø‡¶®
                </p>
            </div>
        </form>
    </div>

    <!-- SCREEN 3: PROCESSING/GRADING LOADER -->
    <div id="processing-loader" class="container">
        <div class="loader-ring"></div>
        <h3 style="color: var(--primary); margin-top: 25px;">AI ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡¶õ‡ßá...</h3>
        <p id="loading-status" style="color: var(--text-light);">Gemini AI ‡¶ñ‡¶æ‡¶§‡¶æ ‡¶¶‡ßá‡¶ñ‡¶õ‡ßá, ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
    </div>

    <!-- SCREEN 4: RESULTS -->
    <div id="result-screen" class="container" style="text-align: center;">
        <h1 style="color: var(--primary);">‡¶´‡¶≤‡¶æ‡¶´‡¶≤</h1>
        <p style="color: var(--text-light); font-size: 1.1rem;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶æ‡¶™‡ßç‡¶§ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</p>
        
        <div class="score-circle">
            <div>
                <span id="final-score">0</span><span style="font-size: 1.5rem; color: #b0bec5; font-weight: 500;">/40</span>
            </div>
        </div>
        
        <div id="ai-feedback-text" class="feedback-box"></div>
        
        <p style="margin-top: 40px; color: var(--text-light); font-size: 0.9rem;">
            ‚úÖ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶™‡¶§‡ßç‡¶∞ ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶∏‡ßÅ‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§
        </p>
    </div>

<script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
    import { initializeAppCheck, ReCaptchaEnterpriseProvider } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app-check.js";

    // --- CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyBF4YKN5INOcDM-tXpYZhtWo1-V9GjPrzs",
        authDomain: "exam-bc5ff.firebaseapp.com",
        projectId: "exam-bc5ff",
        storageBucket: "exam-bc5ff.firebasestorage.app",
        messagingSenderId: "754599664499",
        appId: "1:754599664499:web:af0904450ab52338c94306"
    };

    const GEMINI_API_KEY = "AIzaSyAWccJLqZ_W09paDJ6BBmEjlOmEVZ0WaOc";
    const RECAPTCHA_SITE_KEY = "6LfyUWUsAAAAAF785tS07EnDHeNcSD8M0FzX2jty"; 

    // --- INITIALIZATION ---
    const app = initializeApp(firebaseConfig);
    
    // Initialize App Check
    initializeAppCheck(app, {
        provider: new ReCaptchaEnterpriseProvider(RECAPTCHA_SITE_KEY),
        isTokenAutoRefreshEnabled: true 
    });
    console.log("App Check Initialized");

    const db = getFirestore(app);

    // --- EXAM DATA ---
    const examData = {
        saq: [
            { id: "saq1", q: "‡ßß. '‡¶π‡¶≤‡ßÅ‡¶¶ ‡¶™‡ßã‡ßú‡¶æ' ‡¶ó‡¶≤‡ßç‡¶™‡ßá ‡¶¶‡¶æ‡¶Æ‡¶ø‡¶®‡ßÄ‡¶∞ ‡¶Ö‡¶∏‡ßÅ‡¶ñ‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ï‡¶æ‡¶ï‡ßá ‡¶°‡¶æ‡¶ï‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡¶ø‡¶≤?", m: 2, model: "‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶è‡¶ï‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶™‡¶æ‡¶∏-‡¶ï‡¶∞‡¶æ ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ ‡¶ß‡ßÄ‡¶∞‡ßá‡¶®‡¶ï‡ßá ‡¶°‡¶æ‡¶ï‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡¶ø‡¶≤‡•§" },
            { id: "saq2", q: "‡ß®. '‡¶¨‡¶æ‡¶Å‡¶∂‡¶ü‡¶æ ‡¶∏‡¶∞‡¶ø‡ßü‡ßá ‡¶¶‡¶æ‡¶ì'‚Äî‡¶â‡¶ï‡ßç‡¶§‡¶ø‡¶ü‡¶ø ‡¶ï‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶ï‡ßá‡¶®?", m: 2, model: "‡¶â‡¶ï‡ßç‡¶§‡¶ø‡¶ü‡¶ø ‡¶ß‡ßÄ‡¶∞‡ßá‡¶®‡ßá‡¶∞‡•§ ‡¶∂‡¶æ‡¶®‡ßç‡¶§‡¶ø ‡¶Ö‡¶∂‡¶∞‡ßÄ‡¶∞‡ßÄ ‡¶Ü‡¶ü‡¶ï‡¶æ‡¶§‡ßá ‡¶™‡ßã‡ßú‡¶æ ‡¶¨‡¶æ‡¶Å‡¶∂ ‡¶∞‡ßá‡¶ñ‡ßá‡¶õ‡¶ø‡¶≤, ‡¶Ø‡¶æ ‡¶ß‡ßÄ‡¶∞‡ßá‡¶®‡ßá‡¶∞ ‡¶Æ‡¶®‡ßá ‡¶Æ‡¶æ‡¶®‡¶∏‡¶ø‡¶ï ‡¶¨‡¶æ‡¶ß‡¶æ‡¶∞ ‡¶∏‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡¶ø‡¶≤‡•§" },
            { id: "saq3", q: "‡ß©. ‡¶¨‡¶≤‡¶æ‡¶á ‡¶ö‡¶ï‡ßç‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ‡¶∞ ‡¶Æ‡ßÉ‡¶§‡ßç‡¶Ø‡ßÅ‡¶∞ ‡¶™‡¶∞ ‡¶ï‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶§‡ßç‡¶§‡¶ø‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶æ‡¶ß‡¶ø‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶π‡ßü?", m: 2, model: "‡¶¨‡¶≤‡¶æ‡¶á‡ßü‡ßá‡¶∞ ‡¶≠‡¶æ‡¶á‡¶™‡ßã ‡¶®‡¶¨‡ßÄ‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡¶§‡ßç‡¶§‡¶ø‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶æ‡¶ß‡¶ø‡¶ï‡¶æ‡¶∞‡ßÄ ‡¶π‡ßü‡•§" },
            { id: "saq4", q: "‡ß™. ‡¶ß‡ßÄ‡¶∞‡ßá‡¶®‡ßá‡¶∞ ‡¶™‡ßá‡¶∂‡¶æ‡¶ó‡¶§ ‡¶™‡¶∞‡¶ø‡¶ö‡ßü ‡¶ï‡ßÄ?", m: 2, model: "‡¶ß‡ßÄ‡¶∞‡ßá‡¶® ‡¶™‡ßá‡¶∂‡¶æ‡ßü ‡¶è‡¶ï‡¶ú‡¶® ‡¶∏‡ßç‡¶ï‡ßÅ‡¶≤ ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶è‡¶¨‡¶Ç ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶°‡¶æ‡¶ï‡ßç‡¶§‡¶æ‡¶∞ (‡¶¨‡¶ø‡¶è‡¶∏‡¶∏‡¶ø ‡¶™‡¶æ‡¶∏)‡•§" },
            { id: "saq5", q: "‡ß´. ‡¶ó‡¶≤‡ßç‡¶™‡ßá ‡¶â‡¶≤‡ßç‡¶≤‡¶ø‡¶ñ‡¶ø‡¶§ ‡¶¶‡ßÅ‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶® ‡¶ï‡ßÄ ‡¶ï‡ßÄ?", m: 2, model: "‡¶¨‡¶≤‡¶æ‡¶á ‡¶ö‡¶ï‡ßç‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶è‡¶¨‡¶Ç ‡¶®‡¶¨‡ßÄ‡¶®‡ßá‡¶∞ ‡¶∏‡ßç‡¶§‡ßç‡¶∞‡ßÄ ‡¶∂‡ßÅ‡¶≠‡ßç‡¶∞‡¶æ‡¶∞ ‡¶ñ‡ßÅ‡¶®‡•§" },
            { id: "saq6", q: "‡ß¨. ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡¶¨‡¶æ‡¶∏‡ßÄ‡¶¶‡ßá‡¶∞ ‡¶Æ‡¶§‡ßá ‡¶∂‡ßÅ‡¶≠‡ßç‡¶∞‡¶æ‡¶∞ ‡¶Æ‡ßÉ‡¶§‡ßç‡¶Ø‡ßÅ‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶ï‡ßÄ?", m: 2, model: "‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡¶¨‡¶æ‡¶∏‡ßÄ‡¶∞‡¶æ ‡¶Æ‡¶®‡ßá ‡¶ï‡¶∞‡¶§ ‡¶¨‡¶≤‡¶æ‡¶á‡ßü‡ßá‡¶∞ ‡¶Ö‡¶§‡ßÉ‡¶™‡ßç‡¶§ ‡¶Ü‡¶§‡ßç‡¶Æ‡¶æ ‡¶≠‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶∂‡ßÅ‡¶≠‡ßç‡¶∞‡¶æ‡¶ï‡ßá ‡¶ñ‡ßÅ‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡•§" },
            { id: "saq7", q: "‡ß≠. ‡¶ó‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶∂‡ßá‡¶∑‡ßá ‡¶ß‡ßÄ‡¶∞‡ßá‡¶® ‡¶ï‡ßÄ ‡¶∏‡ßç‡¶¨‡ßÄ‡¶ï‡¶æ‡¶∞‡ßã‡¶ï‡ßç‡¶§‡¶ø ‡¶ï‡¶∞‡ßá‡¶õ‡¶ø‡¶≤?", m: 2, model: "‡¶ß‡ßÄ‡¶∞‡ßá‡¶® ‡¶¨‡¶≤‡ßá‡¶õ‡¶ø‡¶≤: '‡¶Ü‡¶Æ‡¶ø ‡¶¨‡¶≤‡¶æ‡¶á ‡¶ö‡¶ï‡ßç‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ‡•§ ‡¶∂‡ßÅ‡¶≠‡ßç‡¶∞‡¶æ‡¶ï‡ßá ‡¶Ü‡¶Æ‡¶ø ‡¶ñ‡ßÅ‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡¶ø‡•§'" },
            { id: "saq8", q: "‡ßÆ. ‡¶ï‡ßÉ‡¶û‡ßç‡¶ú‡ßÅ ‡¶ó‡ßÅ‡¶£‡¶ø‡¶® ‡¶≠‡ßÇ‡¶§ ‡¶§‡¶æ‡ßú‡¶æ‡¶§‡ßá ‡¶ï‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá‡¶õ‡¶ø‡¶≤?", m: 2, model: "‡¶Æ‡¶®‡ßç‡¶§‡ßç‡¶∞‡¶™‡ßú‡¶æ ‡¶ú‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶™‡ßã‡ßú‡¶æ ‡¶π‡¶≤‡ßÅ‡¶¶‡•§" },
            { id: "saq9", q: "‡ßØ. ‡¶∂‡¶æ‡¶®‡ßç‡¶§‡¶ø ‡¶Ö‡¶∂‡¶∞‡ßÄ‡¶∞‡ßÄ ‡¶Ü‡¶ü‡¶ï‡¶æ‡¶§‡ßá ‡¶ï‡ßÄ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ ‡¶®‡¶ø‡ßü‡ßá‡¶õ‡¶ø‡¶≤?", m: 2, model: "‡¶ò‡¶æ‡¶ü‡ßá‡¶∞ ‡¶™‡¶•‡ßá ‡¶ï‡¶æ‡¶Å‡¶ö‡¶æ ‡¶¨‡¶æ‡¶Å‡¶∂‡ßá‡¶∞ ‡¶Ü‡¶ó‡¶æ‡¶Æ‡¶æ‡¶•‡¶æ ‡¶™‡ßÅ‡ßú‡¶ø‡ßü‡ßá ‡¶Ü‡ßú‡¶æ‡¶Ü‡ßú‡¶ø ‡¶´‡ßá‡¶≤‡ßá ‡¶∞‡ßá‡¶ñ‡ßá‡¶õ‡¶ø‡¶≤‡•§" },
            { id: "saq10", q: "‡ßß‡ß¶. ‡¶ß‡ßÄ‡¶∞‡ßá‡¶® ‡¶¨‡¶æ‡¶Å‡¶∂‡¶ü‡¶ø ‡¶°‡¶ø‡¶ô‡ßã‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶õ‡¶ø‡¶≤ ‡¶®‡¶æ ‡¶ï‡ßá‡¶®?", m: 2, model: "‡¶Æ‡¶æ‡¶®‡¶∏‡¶ø‡¶ï ‡¶¨‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶ì ‡¶ï‡ßÅ‡¶∏‡¶Ç‡¶∏‡ßç‡¶ï‡¶æ‡¶∞‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßá ‡¶®‡¶ø‡¶ú‡ßá‡¶ï‡ßá ‡¶Ö‡¶∂‡¶∞‡ßÄ‡¶∞‡ßÄ ‡¶≠‡¶æ‡¶¨‡¶õ‡¶ø‡¶≤, ‡¶§‡¶æ‡¶á ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶æ‡¶∏ ‡¶ï‡¶∞‡¶§ ‡¶∏‡ßá ‡¶™‡ßã‡ßú‡¶æ ‡¶¨‡¶æ‡¶Å‡¶∂ ‡¶™‡¶æ‡¶∞ ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá ‡¶®‡¶æ‡•§" }
        ],
        laq: [
            { id: "laq1", q: "‡ßß. '‡¶π‡¶≤‡ßÅ‡¶¶ ‡¶™‡ßã‡ßú‡¶æ' ‡¶ó‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶ï‡¶∞‡¶£‡ßá‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶•‡¶ï‡¶§‡¶æ ‡¶¨‡¶ø‡¶ö‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßã‡•§", m: 5, model: "‡¶π‡¶≤‡ßÅ‡¶¶ ‡¶™‡¶¨‡¶ø‡¶§‡ßç‡¶∞‡¶§‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡ßÄ‡¶ï ‡¶π‡¶≤‡ßá‡¶ì '‡¶™‡ßã‡ßú‡¶æ ‡¶π‡¶≤‡ßÅ‡¶¶' ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ö‡¶∂‡ßÅ‡¶≠ ‡¶ì ‡¶≠‡ßå‡¶§‡¶ø‡¶ï‡¶§‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶§‡ßÄ‡¶ï‡•§ ‡¶ó‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ì ‡¶∂‡ßá‡¶∑‡ßá ‡¶™‡ßã‡ßú‡¶æ ‡¶π‡¶≤‡ßÅ‡¶¶‡ßá‡¶∞ ‡¶ó‡¶®‡ßç‡¶ß‡ßá ‡¶ö‡¶∞‡¶ø‡¶§‡ßç‡¶∞‡ßá‡¶∞ ‡¶¨‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶ò‡¶ü‡ßá‡•§ ‡¶§‡¶æ‡¶á ‡¶®‡¶æ‡¶Æ‡¶ï‡¶∞‡¶£‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶û‡ßç‡¶ú‡¶®‡¶æ‡¶ß‡¶∞‡ßç‡¶Æ‡ßÄ‡•§" },
            { id: "laq2", q: "‡ß®. ‡¶ß‡ßÄ‡¶∞‡ßá‡¶® ‡¶ö‡¶∞‡¶ø‡¶§‡ßç‡¶∞‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶ï‡¶∞‡ßã‡•§ ‡¶∏‡ßá ‡¶ï‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶ï‡ßÅ‡¶∏‡¶Ç‡¶∏‡ßç‡¶ï‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∂‡¶ø‡¶ï‡¶æ‡¶∞ ‡¶π‡¶≤‡ßã?", m: 5, model: "‡¶ß‡ßÄ‡¶∞‡ßá‡¶® ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶ì ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§‡¶ø‡¶¨‡¶æ‡¶¶‡ßÄ ‡¶π‡ßü‡ßá‡¶ì ‡¶™‡¶∞‡¶ø‡¶¨‡ßá‡¶∂‡ßá‡¶∞ ‡¶ö‡¶æ‡¶™‡ßá ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßç‡¶§‡ßç‡¶∞‡ßÄ‡¶∞ ‡¶ï‡ßÅ‡¶∏‡¶Ç‡¶∏‡ßç‡¶ï‡¶æ‡¶∞‡ßá ‡¶Æ‡¶æ‡¶®‡¶∏‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶¶‡ßÅ‡¶∞‡ßç‡¶¨‡¶≤ ‡¶π‡ßü‡ßá ‡¶™‡ßú‡ßá, ‡¶∂‡ßá‡¶∑ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶®‡¶ø‡¶ú‡ßá‡¶∞ ‡¶∏‡¶§‡ßç‡¶§‡¶æ ‡¶π‡¶æ‡¶∞‡¶ø‡ßü‡ßá ‡¶´‡ßá‡¶≤‡ßá‡•§" },
            { id: "laq3", q: "‡ß©. '‡¶π‡¶≤‡ßÅ‡¶¶ ‡¶™‡ßã‡ßú‡¶æ' ‡¶ó‡¶≤‡ßç‡¶™‡ßá ‡¶¨‡¶∞‡ßç‡¶£‡¶ø‡¶§ ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡ßÄ‡¶£ ‡¶ï‡ßÅ‡¶∏‡¶Ç‡¶∏‡ßç‡¶ï‡¶æ‡¶∞ ‡¶ì ‡¶Ö‡¶®‡ßç‡¶ß‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶æ‡¶∏‡ßá‡¶∞ ‡¶ö‡¶ø‡¶§‡ßç‡¶∞‡¶ü‡¶ø ‡¶Ü‡¶≤‡ßã‡¶ö‡¶®‡¶æ ‡¶ï‡¶∞‡ßã‡•§", m: 5, model: "‡¶ö‡¶ø‡¶ï‡¶ø‡ßé‡¶∏‡¶æ‡¶∞ ‡¶¨‡¶¶‡¶≤‡ßá ‡¶ì‡¶ù‡¶æ ‡¶°‡¶æ‡¶ï‡¶æ, ‡¶Ö‡¶∏‡ßÅ‡¶ñ‡¶ï‡ßá ‡¶≠‡ßÇ‡¶§‡ßá ‡¶ß‡¶∞‡¶æ ‡¶≠‡¶æ‡¶¨‡¶æ, ‡¶™‡ßã‡ßú‡¶æ ‡¶¨‡¶æ‡¶Å‡¶∂ ‡¶ì ‡¶π‡¶≤‡ßÅ‡¶¶‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‚Äî‡¶∏‡¶¨ ‡¶Æ‡¶ø‡¶≤‡¶ø‡ßü‡ßá ‡¶è‡¶ï ‡¶Ö‡¶®‡ßç‡¶ß‡¶ï‡¶æ‡¶∞‡¶æ‡¶ö‡ßç‡¶õ‡¶®‡ßç‡¶® ‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡ßÄ‡¶£ ‡¶∏‡¶Æ‡¶æ‡¶ú‡ßá‡¶∞ ‡¶õ‡¶¨‡¶ø ‡¶´‡ßÅ‡¶ü‡ßá ‡¶â‡¶†‡ßá‡¶õ‡ßá‡•§" },
            { id: "laq4", q: "‡ß™. ‡¶ó‡¶≤‡ßç‡¶™‡ßá‡¶∞ ‡¶∂‡ßá‡¶∑‡ßá ‡¶ß‡ßÄ‡¶∞‡ßá‡¶®‡ßá‡¶∞ ‡¶∏‡ßç‡¶¨‡ßÄ‡¶ï‡¶æ‡¶∞‡ßã‡¶ï‡ßç‡¶§‡¶ø ‡¶ï‡¶ø ‡¶≠‡ßå‡¶§‡¶ø‡¶ï ‡¶®‡¶æ ‡¶Æ‡¶®‡¶∏‡ßç‡¶§‡¶æ‡¶§‡ßç‡¶§‡ßç‡¶¨‡¶ø‡¶ï? ‡¶Ü‡¶≤‡ßã‡¶ö‡¶®‡¶æ ‡¶ï‡¶∞‡ßã‡•§", m: 5, model: "‡¶è‡¶ü‡¶ø ‡¶Æ‡¶®‡¶∏‡ßç‡¶§‡¶æ‡¶§‡ßç‡¶§‡ßç‡¶¨‡¶ø‡¶ï‡•§ ‡¶Ö‡¶™‡¶∞‡¶æ‡¶ß‡¶¨‡ßã‡¶ß ‡¶¨‡¶æ ‡¶≠‡ßü‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£‡ßá ‡¶ß‡ßÄ‡¶∞‡ßá‡¶®‡ßá‡¶∞ ‡¶Æ‡¶®‡ßá '‡¶¨‡¶≤‡¶æ‡¶á'-‡¶è‡¶∞ ‡¶∏‡¶§‡ßç‡¶§‡¶æ ‡¶Ü‡¶∞‡ßã‡¶™‡¶ø‡¶§ ‡¶π‡ßü‡•§ ‡¶Æ‡¶æ‡¶®‡¶ø‡¶ï ‡¶¨‡¶®‡ßç‡¶¶‡ßç‡¶Ø‡ßã‡¶™‡¶æ‡¶ß‡ßç‡¶Ø‡¶æ‡ßü ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ï‡ßÅ‡¶∏‡¶Ç‡¶∏‡ßç‡¶ï‡¶æ‡¶∞‡ßá‡¶∞ ‡¶Æ‡¶®‡¶∏‡ßç‡¶§‡¶§‡ßç‡¶§‡ßç‡¶¨ ‡¶¶‡ßá‡¶ñ‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶®‡•§" }
        ]
    };

    // --- VARIABLES ---
    let timerInterval;
    const EXAM_DURATION_MS = 2 * 60 * 60 * 1000; // 2 Hours
    
    // --- INIT ---
    window.onload = function() {
        checkExistingSession();
        preventCheating();
    };

    function preventCheating() {
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.onkeydown = function(e) {
            if (e.keyCode == 123) return false;
            if (e.ctrlKey && (e.key === 'c' || e.key === 'v' || e.key === 'u')) return false;
        }
    }

    // --- SESSION CHECK ---
    function checkExistingSession() {
        const studentName = localStorage.getItem('wb_exam_student');
        const endTime = localStorage.getItem('wb_exam_end_time'); 
        const status = localStorage.getItem('wb_exam_status'); 
        
        if (status === 'submitted') {
            showResultScreen(localStorage.getItem('wb_exam_score'), localStorage.getItem('wb_exam_feedback'));
            return;
        }

        if (studentName && endTime) {
            const now = Date.now();
            if (now > parseInt(endTime)) {
                localStorage.setItem('wb_exam_status', 'submitted'); 
                alert("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü‡¶∏‡ßÄ‡¶Æ‡¶æ ‡¶™‡¶æ‡¶∞ ‡¶π‡ßü‡ßá ‡¶ó‡ßá‡¶õ‡ßá‡•§");
                showResultScreen(0, "Time Expired - No Submission recorded.");
            } else {
                document.getElementById('login-screen').style.display = 'none';
                renderExam(studentName);
                startTicker(parseInt(endTime));
            }
        } else {
            document.getElementById('login-screen').style.display = 'block';
        }
    }

    // --- START SEQUENCE ---
    window.initiateExamSequence = function() {
        const nameInput = document.getElementById('student-name').value.trim();
        if (!nameInput) {
            alert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§");
            return;
        }

        localStorage.setItem('wb_exam_student', nameInput);
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('startup-loader').style.display = 'block';

        setTimeout(() => {
            const now = Date.now();
            const endTime = now + EXAM_DURATION_MS;

            const formattedStartTime = new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" });
            localStorage.setItem('wb_exam_start_date', formattedStartTime);
            localStorage.setItem('wb_exam_end_time', endTime);
            localStorage.setItem('wb_exam_status', 'ongoing');

            document.getElementById('startup-loader').style.display = 'none';
            renderExam(nameInput);
            startTicker(endTime);
        }, 2000);
    };

    // --- TIMER ---
    function startTicker(endTime) {
        const timerDisplay = document.getElementById('timer-display');
        updateTimerUI(endTime);

        timerInterval = setInterval(() => {
            const isExpired = updateTimerUI(endTime);
            if (isExpired) {
                clearInterval(timerInterval);
                alert("‡¶∏‡¶Æ‡ßü ‡¶∂‡ßá‡¶∑! ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§");
                submitExam(true);
            }
        }, 1000);
    }

    function updateTimerUI(endTime) {
        const now = Date.now();
        const diff = endTime - now;
        const timerDisplay = document.getElementById('timer-display');

        if (diff <= 0) {
            timerDisplay.textContent = "00:00:00";
            return true;
        }

        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((diff % (1000 * 60)) / 1000);

        timerDisplay.textContent = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        if (diff < 300000) timerDisplay.classList.add('critical');
        return false;
    }

    // --- RENDER UI ---
    function renderExam(name) {
        document.getElementById('login-screen').style.display = 'none';
        const displayName = name || localStorage.getItem('wb_exam_student') || "Student";
        document.getElementById('exam-screen').style.display = 'block';
        document.getElementById('display-name').textContent = displayName;

        const container = document.getElementById('questions-container');
        if (container.innerHTML !== "") return;

        let html = "";
        
        // SAQ
        html += `<div class="section-header">‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó '‡¶ï': ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡¶ø‡¶™‡ßç‡¶§ ‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶ß‡¶∞‡ßç‡¶Æ‡ßÄ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® (SAQ)</div>`;
        examData.saq.forEach((q) => {
            const savedAns = localStorage.getItem(`ans_${q.id}`) || "";
            // Added class 'exam-answer-box' for precise counting
            html += `
                <div class="question-card">
                    <span class="q-text">${q.q} <span class="marks-tag">${q.m} ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</span></span>
                    <textarea class="exam-answer-box" id="${q.id}" rows="2" placeholder="‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." oninput="window.saveProgress(this)">${savedAns}</textarea>
                </div>`;
        });

        // LAQ
        html += `<div class="section-header">‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó '‡¶ñ': ‡¶∞‡¶ö‡¶®‡¶æ‡¶ß‡¶∞‡ßç‡¶Æ‡ßÄ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® (LAQ)</div>`;
        examData.laq.forEach((q) => {
            const savedAns = localStorage.getItem(`ans_${q.id}`) || "";
            // Added class 'exam-answer-box' for precise counting
            html += `
                <div class="question-card">
                    <span class="q-text">${q.q} <span class="marks-tag">${q.m} ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</span></span>
                    <textarea class="exam-answer-box" id="${q.id}" rows="6" placeholder="‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." oninput="window.saveProgress(this)">${savedAns}</textarea>
                </div>`;
        });

        container.innerHTML = html;
        
        checkCompletion();
    }

    // --- SAVE PROGRESS & CHECK ---
    window.saveProgress = function(element) {
        localStorage.setItem(`ans_${element.id}`, element.value);
        checkCompletion();
    };

    function checkCompletion() {
        // Updated to use the specific class we added
        const inputs = document.querySelectorAll('.exam-answer-box');
        let filledCount = 0;
        // Hardcoded total based on data source to prevent any "Ghost Question" error
        const totalCount = examData.saq.length + examData.laq.length; // Always 14

        inputs.forEach(input => {
            if (input.value.trim().length > 0) filledCount++;
        });

        const btn = document.getElementById('submit-btn');
        // Ensure filledCount doesn't visually exceed totalCount
        const displayCount = Math.min(filledCount, totalCount); 
        const isComplete = displayCount === totalCount;

        if (isComplete) {
            btn.disabled = false;
            btn.innerHTML = "‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶™‡¶§‡ßç‡¶∞ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶® (Submit)";
            btn.classList.add("btn-active");
            document.getElementById('progress-text').textContent = "‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡¶¨ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶®‡•§";
            document.getElementById('progress-text').style.color = "green";
        } else {
            btn.disabled = true;
            btn.classList.remove("btn-active");
            btn.innerHTML = `Submit (${displayCount}/${totalCount})`;
            document.getElementById('progress-text').textContent = "‡¶∏‡¶¨ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡¶ø‡¶≤‡ßá ‡¶¨‡¶æ‡¶ü‡¶®‡¶ü‡¶ø ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü ‡¶π‡¶¨‡ßá‡•§";
            document.getElementById('progress-text').style.color = "#90a4ae";
        }
    }

    // --- SUBMIT ---
    window.submitExam = async function(force = false) {
        if (!force && !confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§? ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶≤‡ßá ‡¶Ü‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§")) return;

        clearInterval(timerInterval);
        document.getElementById('exam-screen').style.display = 'none';
        document.getElementById('processing-loader').style.display = 'block';

        const studentAnswers = {};
        const allQuestions = [...examData.saq, ...examData.laq];
        
        allQuestions.forEach(q => {
            const val = document.getElementById(q.id)?.value || localStorage.getItem(`ans_${q.id}`) || "‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡¶®‡¶ø";
            studentAnswers[q.id] = {
                question: q.q,
                user_answer: val,
                model_answer: q.model,
                marks: q.m
            };
        });

        try {
            document.getElementById('loading-status').textContent = "AI ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï ‡¶ñ‡¶æ‡¶§‡¶æ ‡¶¶‡ßá‡¶ñ‡¶õ‡ßá‡¶®...";
            
            // Call REST API
            const aiResult = await verifyWithGeminiRest(studentAnswers);
            
            document.getElementById('loading-status').textContent = "‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
            const savedName = localStorage.getItem('wb_exam_student');
            const startTimeStr = localStorage.getItem('wb_exam_start_date') || "Unknown";
            const submissionTimeStr = new Date().toLocaleString("en-IN", { timeZone: "Asia/Kolkata" });
            
            try {
                await addDoc(collection(db, "exam_submissions"), {
                    student_name: savedName,
                    answers: studentAnswers,
                    score: aiResult.total_score,
                    feedback: aiResult.breakdown,
                    start_time: startTimeStr,
                    submission_time: submissionTimeStr,
                    timestamp: serverTimestamp()
                });
            } catch (dbError) {
                console.error("Firebase DB Error:", dbError);
            }

            localStorage.setItem('wb_exam_status', 'submitted');
            localStorage.setItem('wb_exam_score', aiResult.total_score);
            localStorage.setItem('wb_exam_feedback', aiResult.breakdown);

            showResultScreen(aiResult.total_score, aiResult.breakdown);

        } catch (error) {
            console.error("Submission Error:", error);
            showResultScreen(localStorage.getItem('wb_exam_score') || 0, "Error: " + error.message);
        }
    };

    async function verifyWithGeminiRest(answersData) {
        // USING GEMINI-1.5-FLASH
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        
        const promptText = `
        You are a strict Bengali Literature Examiner (‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶ï).
        Task: Grade the student's answers based on the Model Answers.
        Total Marks: 40.
        
        Input Data (JSON): ${JSON.stringify(answersData)}
        
        Rules:
        1. Compare user_answer with model_answer.
        2. Give partial marks for partially correct answers.
        3. 0 marks if empty or irrelevant.
        4. Output strictly valid JSON ONLY. No markdown code blocks.
        
        Output Structure:
        {
            "total_score": number,
            "breakdown": "Bengali Feedback String"
        }
        `;

        const requestBody = {
            contents: [{
                parts: [{ text: promptText }]
            }]
        };

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            const errorBody = await response.text();
            console.error("AI Error:", errorBody);
            throw new Error(`AI API Failed (${response.status}). Check 'Generative Language API' in Google Console.`);
        }

        const data = await response.json();
        const text = data.candidates[0].content.parts[0].text;
        const cleanJson = text.replace(/```json/g, '').replace(/```/g, '').trim();
        return JSON.parse(cleanJson);
    }

    function showResultScreen(score, feedback) {
        document.getElementById('processing-loader').style.display = 'none';
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('startup-loader').style.display = 'none';
        document.getElementById('exam-screen').style.display = 'none';
        
        const resScreen = document.getElementById('result-screen');
        resScreen.style.display = 'block';
        resScreen.classList.add('container'); 
        
        document.getElementById('final-score').textContent = score;
        document.getElementById('ai-feedback-text').textContent = feedback;
    }
</script>

</body>
</html>
